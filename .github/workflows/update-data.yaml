name: Update IANA Data

on:
  schedule:
    # Run daily at 2:00 AM UTC / 18:00 US-Pacific
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual triggering

# Prevent concurrent runs
concurrency:
  group: update-iana-data
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v6.0.0

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          enable-cache: true
          version-file: "pyproject.toml"

      - name: Install dependencies
        run: make deps

      # Download core IANA files
      - name: Download core data (RDAP, TLD list, root zone DB)
        id: download-core
        continue-on-error: true
        run: make download-core

      - name: Notification if core download fails
        if: steps.download-core.outcome == 'failure'
        uses: ./.github/actions/pushover
        with:
          pushover_api_token: ${{ secrets.PUSHOVER_API_TOKEN }}
          pushover_user_key: ${{ secrets.PUSHOVER_USER_KEY }}
          title: "IANA core data download failed"
          message: "❌ Failed to download IANA core data files"

      - name: Generate IDN script mappings
        id: generate-idn-mapping
        continue-on-error: true
        run: make generate-idn-mapping

      - name: Notification if IDN mapping fails
        if: steps.generate-idn-mapping.outcome == 'failure'
        uses: ./.github/actions/pushover
        with:
          pushover_api_token: ${{ secrets.PUSHOVER_API_TOKEN }}
          pushover_user_key: ${{ secrets.PUSHOVER_USER_KEY }}
          title: "IANA data - IDN mapping generation failed"
          message: "❌ Failed to generate IDN script mappings"

      # Download TLD pages in 8 batches for better error isolation
      # Total: 1,592 TLDs, ~200 per batch, ~3-4 min each
      # Continue on error to allow other batches to complete

      - name: "Download TLDs: a-b (198 TLDs)"
        id: download-tlds-ab
        continue-on-error: true
        run: make download-tld-pages GROUPS="a b"

      - name: "Download TLDs: c-d (187 TLDs)"
        id: download-tlds-cd
        continue-on-error: true
        run: make download-tld-pages GROUPS="c d"

      - name: "Download TLDs: e-h (227 TLDs)"
        id: download-tlds-eh
        continue-on-error: true
        run: make download-tld-pages GROUPS="e f g h"

      - name: "Download TLDs: i + IDN (215 TLDs)"
        id: download-tlds-i-idn
        continue-on-error: true
        run: make download-tld-pages GROUPS="i xn--"

      - name: "Download TLDs: j-m (221 TLDs)"
        id: download-tlds-jm
        continue-on-error: true
        run: make download-tld-pages GROUPS="j k l m"

      - name: "Download TLDs: n-q (158 TLDs)"
        id: download-tlds-nq
        continue-on-error: true
        run: make download-tld-pages GROUPS="n o p q"

      - name: "Download TLDs: r-s (190 TLDs)"
        id: download-tlds-rs
        continue-on-error: true
        run: make download-tld-pages GROUPS="r s"

      - name: "Download TLDs: t-z (188 TLDs)"
        id: download-tlds-tz
        continue-on-error: true
        run: make download-tld-pages GROUPS="t u v w y z"

      - name: Notification if TLD download fails
        if: |
          steps.download-tlds-ab.outcome == 'failure' ||
          steps.download-tlds-cd.outcome == 'failure' ||
          steps.download-tlds-eh.outcome == 'failure' ||
          steps.download-tlds-i-idn.outcome == 'failure' ||
          steps.download-tlds-jm.outcome == 'failure' ||
          steps.download-tlds-nq.outcome == 'failure' ||
          steps.download-tlds-rs.outcome == 'failure' ||
          steps.download-tlds-tz.outcome == 'failure'
        uses: ./.github/actions/pushover
        with:
          pushover_api_token: ${{ secrets.PUSHOVER_API_TOKEN }}
          pushover_user_key: ${{ secrets.PUSHOVER_USER_KEY }}
          title: "IANA TLD data download failed"
          message: "❌ Failed to download IANA TLD data files"

      - name: Check if source data changed
        id: source-check
        run: |
          # Check if data/source/ has any changes (not just metadata.json)
          if git diff --quiet data/source/; then
            echo "Source files unchanged (timestamp updates only)"
            echo "source_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Source files have content changes"
            echo "source_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        id: run-tests
        if: steps.source-check.outputs.source_changed == 'true'
        continue-on-error: true
        run: |
          set -o pipefail
          make test 2>&1 | tee test-output.log

      - name: Notification if tests fail
        if: steps.run-tests.outcome == 'failure'
        uses: ./.github/actions/pushover
        with:
          pushover_api_token: ${{ secrets.PUSHOVER_API_TOKEN }}
          pushover_user_key: ${{ secrets.PUSHOVER_USER_KEY }}
          title: "IANA data - tests failed"
          message: "❌ Tests failed for iana-data"

      - name: Build tlds.json
        if: steps.source-check.outputs.source_changed == 'true'
        id: build
        continue-on-error: true
        run: make build

      - name: Notification if build fails
        if: steps.build.outcome == 'failure'
        uses: ./.github/actions/pushover
        with:
          pushover_api_token: ${{ secrets.PUSHOVER_API_TOKEN }}
          pushover_user_key: ${{ secrets.PUSHOVER_USER_KEY }}
          title: "IANA data - tlds.json build failed"
          message: "❌ Failed to build tlds.json"

      - name: Check for changes
        id: git-check
        if: always()
        run: |
          if ! git diff --exit-code data/; then
            echo "changed=true" >> $GITHUB_OUTPUT
            # Get list of changed files in data/ directory
            CHANGED_FILES=$(git diff --name-only data/ | sed 's|^data/source/||' | sed 's|^data/generated/||')
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: always() && steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/

          # Build commit message with actual changed files
          COMMIT_MSG="Update IANA source data files"
          if [ -n "${{ steps.git-check.outputs.files }}" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          Changed files:"
            while IFS= read -r file; do
              COMMIT_MSG="${COMMIT_MSG}
          - ${file}"
            done <<< "${{ steps.git-check.outputs.files }}"
          fi

          git commit -m "${COMMIT_MSG}"
          git push

      - name: Notification if data committed
        if: always() && steps.git-check.outputs.changed == 'true'
        uses: ./.github/actions/pushover
        with:
          pushover_api_token: ${{ secrets.PUSHOVER_API_TOKEN }}
          pushover_user_key: ${{ secrets.PUSHOVER_USER_KEY }}
          title: "IANA data - successfully updated"
          message: "✅ Successfully updated and committed IANA data"
